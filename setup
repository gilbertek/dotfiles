#!/usr/bin/env bash

# Install dotfiles symlinks.
set -e

DOTFILES="$HOME/dotfiles"

msg() {
  printf '%b\n' "$1" >&2
}

success() {
  if [ "$ret" -eq '0' ]; then
    msg "\\033[32m[âœ”]\\033[0m ${1}${2}"
  fi
}

warning(){
  msg "\033[33mWarning:\033[0m ${1}${2}"
}

_FILES=(
  railsrc
  tmux.conf
  tmux-osx.conf
  tmux-linux.conf
  editorconfig
  prettierrc
  eslintrc
  ctags
  pryrc
  tool-versions
  bashrc
  bash_profile
)

echo -e "\nCreating dotfile symlinks"

# Setup bash.d directory
if [ ! -d "$HOME/.bash.d" ]; then
  mkdir -p "$HOME/.bash.d"
fi

if [ ! -d "$HOME/bin" ]; then
  mkdir -p "$HOME/bin"
fi

create_bash_links() {
  for f in "${DOTFILES}"/system/bash.d/*; do
    ln -sfn  "$f"  ~/.bash.d
  done
}

create_tool_links() {
  for file in "${_FILES[@]}"; do
    filename=".$(basename $file '.symlink')"
    target="$HOME/$filename"

    if [ -e "$target" ] && [ ! -d "$target" ]; then
      warning "${filename} alreadly exists in your home directory. Are you sure to overwrite it? ([y]/n)"
      read -r -n 1;
      msg ""
      if [[ ! $REPLY ]] || [[ $REPLY =~ ^[Yy]$ ]]; then
        ln -snf "${DOTFILES}/system/${file}" "${target}"
      fi
    else
      ln -snf "${DOTFILES}/system/${file}" "${target}"
    fi
  done
}

create_bin_links() {
  for file in "$DOTFILES"/bin/*; do
    name="$(basename ${file%%.*})"
    target="$HOME/bin/$name"

    cp -n "$file" "$target"
    chmod +x "$target"
  done
}

# neovim and vim config
echo -e "\nCreating config symlinks"
if [ ! -d "$HOME/.config/nvim" ]; then
  mkdir -p "$HOME/.config/nvim"
fi

if [ ! -f "$HOME/.config/nvim/init.vim" ]; then
  ln -sfn "$DOTFILES/config/nvim/init.vim" "$HOME/.config/nvim/init.vim"
  ln -sfn "${DOTFILES}/config/nvim/coc-settings.json"  "$HOME/.config/nvim/coc-settings.json"
fi
# Git and Hub config
if [ ! -d "$HOME/.config/git" ]; then
  mkdir -p ~/.config/git
fi

ln -sfn "$DOTFILES/config/git/gitconfig" ~/.gitconfig

# mkdir -p ~/.sbt/1.3.10/plugins
# ln -s "$DOTFILES/system/sbtplugins.sbt" ~/.sbt/1.3.10/plugins/dotfileplugins.sbt

if [ ! -f "$HOME/.cargo/config" ]; then
	mkdir -p ~/.cargo && ln -sfn "$DOTFILES/config/cargo/config" "$HOME/.cargo/config"
fi

create_bash_links
create_tool_links
create_bin_links

ret="$?"
success "Dotfiles have been configured! ðŸ¤˜"
