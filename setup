#!/usr/bin/env bash

# Install dotfiles symlinks.
set -e

REPO_URL="https://github.com/gilbertek/dotfiles"
REPO_NAME="dotfiles"

BACKUP_SUFFIX=".bak.$(date +%s)"

MODULES=(
    nvim
    # ghostty
    # starship
    # hypr
)

msg() {
    printf '%b\n' "$1" >&2
}

success() {
    if [ "$ret" -eq '0' ]; then
        msg "\\033[32m[âœ”]\\033[0m ${1}${2}"
    fi
}

warning() {
    msg "\033[33mWarning:\033[0m ${1}${2}"
}

backup_file() {
    local path="$1"
    if [ -e "$path" ]; then
        local backup="${path}${BACKUP_SUFFIX}"
        echo "Backing up $path -> $backup"
        mv "$path" "$backup"
    fi
}

check_conflicts() {
    local module="$1"
    echo "Checking for conflicts in module: $module"

    cd "${REPO_NAME}"

    # Detect conflict using stow dry-run
    local conflicts
    conflicts=$(stow -nv "${module}" 2>&1 | grep -o "over existing target [^ ]*" | awk '{print $4}' || true)

    for file in $conflicts; do
        backup_file "${HOME}/${file}"
    done
}

# Check if the repository already exists
if [[ -d "${REPO_NAME}" ]]; then
    echo "Repository ${REPO_NAME} already exists. Skipping clone..."
else
    git clone "${REPO_URL}"
fi

install_modules() {
    echo "Installing dotfile modules via stow..."
    # Make sure we run the script from the $HOME directory
    cd "${HOME}/${REPO_NAME}"

    for module in "${MODULES[@]}"; do
        check_conflicts "${module}"

        echo "Installing $module"
        stow "${module}"
    done
}

# Check if the clone was successful
if [[ $? -eq 0 ]]; then

    echo "Removing old configs"
    rm -rf ~/.config/nvim
    # rm -rf ~/.config/ghostty
    # rm -rf ~/.config/starship.toml
    rm -rf ~/.local/share/nvim
    rm -rf ~/.cache/nvim
    # Change directory into $HOME/dotfiles
    cd "${HOME}"/dotfiles

    # Install all other packages
    ./scripts/system/removal.sh
    ./scripts/system/install-extras.sh
    ./scripts/system/install-pgsql.sh

    # Use stow to symlink user configs
    stow nvim
    # stow starship
else
    echo "Failed to clone the repository: ${REPO_NAME}"
fi

success "Dotfiles have been configured! ðŸ¤˜"
