#!/usr/bin/env bash

# Install dotfiles symlinks.
set -e

DOTFILES="$HOME/dotfiles"

msg() {
  printf '%b\n' "$1" >&2
}

success() {
  if [ "$ret" -eq '0' ]; then
    msg "\\033[32m[âœ”]\\033[0m ${1}${2}"
  fi
}

warning(){
  msg "\033[33mWarning:\033[0m ${1}${2}"
}

mkdir_path() {
  echo "==> creating path : $1"
  mkdir -p "$1"
}

os=$(uname -s | tr "[:upper:]" "[:lower:]")

case $os in
  linux)
  os="linux"
  ;;
  darwin)
  os="osx"
  ;;
  *)
  printf "%s doesn't supported by bash installer" "$os"
  exit 1
  ;;
esac

# This detection only works for mac and linux.
if [ "$(uname)" == "Darwin" ]; then
  msg "Setting up $HOME/.bash_profile"
  ln -snf "${DOTFILES}/system/osx/bash_profile" "$HOME/.bash_profile"
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
  msg "seeting up ${HOME}/.bashrc"
  ln -snf "${DOTFILES}/system/linux/bashrc" "$HOME/.bashrc"
fi


_FILES=(
  aliases
  functions
  railsrc
  tmux.conf
  tmux-osx.conf
  tmux-linux.conf
  editorconfig
  prettierrc
  eslintrc
  ctags
  pryrc
  tool-versions
  # .tigrc
  # .rubocop.yml
)

echo -e "\nCreating dotfile symlinks"

create_symlinks() {
  for file in "${_FILES[@]}"; do
    filename=".$(basename $file '.symlink')"
    target="$HOME/$filename"

    if [ -e "$target" ] && [ ! -d "$target" ]; then
      warning "${filename} alreadly exists in your home directory. Are you sure to overwrite it? ([y]/n)"
      read -r -n 1;
      msg ""
      if [[ ! $REPLY ]] || [[ $REPLY =~ ^[Yy]$ ]]; then
        ln -snf "${DOTFILES}/system/${file}" "${target}"
      fi
    else
      ln -snf "${DOTFILES}/system/${file}" "${target}"
    fi
  done
}

create_bin_symlinks() {
  for file in "$DOTFILES"/bin/*; do
    name="$(basename ${file%%.*})"
    target="$HOME/bin/$name"

    cp -n "$file" "$target"
    chmod +x "$target"
  done
}

# neovim and vim config
echo -e "\nCreating config symlinks"
if [ ! -d "$HOME/.config/nvim" ]; then
  mkdir -p "$HOME/.config/nvim"
fi

if [ ! -f "$HOME/.config/nvim/init.vim" ]; then
  ln -sfn "$DOTFILES/config/nvim/init.vim" "$HOME/.config/nvim/init.vim"
  ln -sfn "${DOTFILES}/config/nvim/coc-settings.json"  "$HOME/.config/nvim/coc-settings.json"
fi
# Git and Hub config
if [ ! -d "$HOME/.config/git" ]; then
  mkdir -p ~/.config/git
fi

ln -sfn "$DOTFILES/config/git/gitconfig" ~/.gitconfig

if [ ! -d "$HOME/bin" ]; then
  mkdir -p "$HOME/bin"
fi

# mkdir -p ~/.sbt/1.3.10/plugins
# ln -s "$DOTFILES/system/sbtplugins.sbt" ~/.sbt/1.3.10/plugins/dotfileplugins.sbt

if [[ ! -f ~/.cargo/config ]]; then
	mkdir -p ~/.cargo && ln -s "$DOTFILES/config/cargo/config" "$HOME/.cargo/config"
fi

create_symlinks
create_bin_symlinksinstalls/asdf/

ret="$?"
success "Dotfiles have been configured! ðŸ¤˜"
